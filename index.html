<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω - –¢—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</title>
    <!-- VexFlow –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –Ω–æ—Ç -->
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.5/build/cjs/vexflow.js"></script>
    <!-- –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è SVG –∫–∞–∫ PNG -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1000px;
            width: 100%;
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        h1 span {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .main-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .main-panel {
                grid-template-columns: 1fr;
            }
        }
        
        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –≤–≤–æ–¥ */
        .input-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }
        
        .notes-display {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #dee2e6;
        }
        
        .notes-list {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
            word-wrap: break-word;
            min-height: 60px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #ced4da;
            font-family: 'Courier New', monospace;
        }
        
        .notes-count {
            text-align: right;
            color: #6c757d;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .note-keyboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .note-btn {
            background: white;
            border: 2px solid #e9ecef;
            color: #495057;
            padding: 12px 5px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .note-btn:hover {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.4);
        }
        
        .note-btn.sharp-flat {
            background: #e9ecef;
        }
        
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .octave-selector {
            margin-bottom: 15px;
        }
        
        .octave-label {
            display: block;
            margin-bottom: 10px;
            color: #495057;
            font-weight: 500;
        }
        
        .octave-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .octave-btn {
            background: white;
            border: 2px solid #dee2e6;
            color: #495057;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 45px;
        }
        
        .octave-btn.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }
        
        .transpose-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .transpose-input {
            flex: 2;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            min-width: 120px;
        }
        
        .transpose-btn {
            flex: 1;
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .transpose-btn:hover {
            background: #218838;
        }
        
        .manual-input-area {
            margin-top: 20px;
        }
        
        .manual-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .manual-input:focus {
            outline: none;
            border-color: #1e3c72;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            background: white;
            border: 2px solid #dee2e6;
            color: #495057;
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }
        
        .action-btn.clear:hover {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        .action-btn.save:hover {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –Ω–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω */
        .notation-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .notation-title {
            color: #495057;
            font-weight: 500;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #notation {
            background: white;
            border-radius: 10px;
            min-height: 200px;
            width: 100%;
            overflow-x: auto;
        }
        
        .notation-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }
        
        .notation-btn {
            background: white;
            border: 2px solid #dee2e6;
            color: #495057;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .notation-btn:hover {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }
        
        .info-text {
            color: #6c757d;
            font-size: 13px;
            margin-top: 10px;
            padding: 8px;
            background: #e9ecef;
            border-radius: 6px;
        }
        
        .info-text code {
            background: white;
            padding: 2px 4px;
            border-radius: 4px;
            color: #e83e8c;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3c72;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéº <span>–ù–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω –æ–Ω–ª–∞–π–Ω</span> üéº</h1>
        
        <div class="main-panel">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –≤–≤–æ–¥ -->
            <div class="input-panel">
                <div class="notes-display">
                    <div class="notes-list" id="notesList">üéµ –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–æ—Ç</div>
                    <div class="notes-count" id="notesCount">–í—Å–µ–≥–æ –Ω–æ—Ç: 0</div>
                </div>
                
                <!-- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–æ—Ç -->
                <div class="note-keyboard" id="noteKeyboard"></div>
                
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
                <div class="control-panel">
                    <div class="octave-selector">
                        <div class="octave-label">üéπ –û–∫—Ç–∞–≤–∞:</div>
                        <div class="octave-buttons" id="octaveButtons"></div>
                    </div>
                    
                    <div class="transpose-controls">
                        <input type="number" id="transposeInput" class="transpose-input" placeholder="–ü–æ–ª—É—Ç–æ–Ω–∞" min="-12" max="12" value="0">
                        <button class="transpose-btn" id="transposeBtn">üîÑ –¢—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                
                <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ -->
                <div class="manual-input-area">
                    <input type="text" id="manualInput" class="manual-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ—Ç—ã (C4 Eb5 F#3 –∏–ª–∏ C Eb F#)">
                    <div class="action-buttons">
                        <button class="action-btn" id="addManualBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                        <button class="action-btn clear" id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –Ω–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω -->
            <div class="notation-panel">
                <div class="notation-title">
                    <span>üéº –ù–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω</span>
                    <span id="keySignature">–î–æ –º–∞–∂–æ—Ä</span>
                </div>
                
                <div id="notation"></div>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>–û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–æ—Ç...</div>
                </div>
                
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
                <div class="error-message" id="errorMessage"></div>
                
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ—Ç–∞—Ü–∏–µ–π -->
                <div class="notation-controls">
                    <button class="notation-btn" id="refreshNotationBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button class="notation-btn" id="saveAsPngBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PNG</button>
                </div>
                
                <div class="info-text">
                    <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –Ω–æ—Ç—ã:</strong> –í—Å–µ –Ω–æ—Ç—ã —Å –¥–∏–µ–∑–∞–º–∏ (#) –∏ –±–µ–º–æ–ª—è–º–∏ (b).<br>
                    <strong>–û–∫—Ç–∞–≤—ã:</strong> 0-7 (–æ—Ç —Å—É–±–∫–æ–Ω—Ç—Ä–æ–∫—Ç–∞–≤—ã –¥–æ –ø—è—Ç–æ–π)
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –Ω–æ—Ç
        const NOTE_TO_SEMITONE = {
            'C': 0, 'C#': 1, 'Db': 1,
            'D': 2, 'D#': 3, 'Eb': 3,
            'E': 4, 'F': 5, 'F#': 6, 'Gb': 6,
            'G': 7, 'G#': 8, 'Ab': 8,
            'A': 9, 'A#': 10, 'Bb': 10,
            'B': 11
        };

        const SEMITONE_TO_NOTE = {
            0: 'C', 1: 'C#', 2: 'D', 3: 'D#', 4: 'E', 5: 'F',
            6: 'F#', 7: 'G', 8: 'G#', 9: 'A', 10: 'A#', 11: 'B'
        };

        // –ú–∞–ø–ø–∏–Ω–≥ –¥–ª—è VexFlow (–Ω–æ—Ç—ã –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –Ω–æ—Ç–∞—Ü–∏–∏)
        const VEXFLOW_NOTE_MAP = {
            'C': 'c', 'C#': 'c#', 'Db': 'db',
            'D': 'd', 'D#': 'd#', 'Eb': 'eb',
            'E': 'e', 'F': 'f', 'F#': 'f#',
            'Gb': 'gb', 'G': 'g', 'G#': 'g#',
            'Ab': 'ab', 'A': 'a', 'A#': 'a#',
            'Bb': 'bb', 'B': 'b'
        };

        // –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ—Ç—ã
        const ALL_NOTES = ['C', 'C#', 'Db', 'D', 'D#', 'Eb', 'E', 'F', 'F#', 'Gb', 'G', 'G#', 'Ab', 'A', 'A#', 'Bb', 'B'];

        // –†–∞–∑–±–∏–≤–∫–∞ –Ω–æ—Ç –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        const NOTE_ROWS = [
            ['C', 'C#', 'Db', 'D'],
            ['D#', 'Eb', 'E', 'F'],
            ['F#', 'Gb', 'G', 'G#'],
            ['Ab', 'A', 'A#', 'Bb'],
            ['B']
        ];

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let collectedNotes = []; // –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {note, octave}
        let selectedOctave = 4;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VexFlow
        let vfContext = null;
        let vfRenderer = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            createNoteKeyboard();
            createOctaveButtons();
            updateNotesDisplay();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('transposeBtn').addEventListener('click', transposeNotes);
            document.getElementById('addManualBtn').addEventListener('click', addManualNotes);
            document.getElementById('clearBtn').addEventListener('click', clearNotes);
            document.getElementById('refreshNotationBtn').addEventListener('click', renderNotation);
            document.getElementById('saveAsPngBtn').addEventListener('click', saveAsPNG);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
            document.getElementById('manualInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addManualNotes();
                }
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º VexFlow
            initVexFlow();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VexFlow
        function initVexFlow() {
            try {
                const div = document.getElementById('notation');
                div.innerHTML = '';
                
                // –°–æ–∑–¥–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä
                vfRenderer = new Vex.Flow.Renderer(div, Vex.Flow.Renderer.Backends.SVG);
                vfRenderer.resize(600, 200);
                vfContext = vfRenderer.getContext();
                
                renderNotation();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ VexFlow:', e);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–æ—Ç
        function createNoteKeyboard() {
            const keyboard = document.getElementById('noteKeyboard');
            keyboard.innerHTML = '';
            
            NOTE_ROWS.forEach(row => {
                row.forEach(note => {
                    const btn = document.createElement('button');
                    btn.className = `note-btn ${note.includes('#') || note.includes('b') ? 'sharp-flat' : ''}`;
                    btn.textContent = note;
                    btn.onclick = () => addNote(note);
                    keyboard.appendChild(btn);
                });
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –æ–∫—Ç–∞–≤—ã
        function createOctaveButtons() {
            const container = document.getElementById('octaveButtons');
            container.innerHTML = '';
            
            for (let i = 0; i <= 7; i++) {
                const btn = document.createElement('button');
                btn.className = `octave-btn ${i === selectedOctave ? 'active' : ''}`;
                btn.textContent = i;
                btn.onclick = () => selectOctave(i);
                container.appendChild(btn);
            }
        }

        // –í—ã–±–æ—Ä –æ–∫—Ç–∞–≤—ã
        function selectOctave(octave) {
            selectedOctave = octave;
            
            document.querySelectorAll('.octave-btn').forEach(btn => {
                if (parseInt(btn.textContent) === octave) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ—Ç—ã
        function addNote(note) {
            if (collectedNotes.length >= 30) {
                alert('‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ 30 –Ω–æ—Ç!');
                return;
            }
            
            collectedNotes.push({
                note: note,
                octave: selectedOctave
            });
            
            updateNotesDisplay();
            renderNotation();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ—Ç
        function updateNotesDisplay() {
            const notesList = document.getElementById('notesList');
            const notesCount = document.getElementById('notesCount');
            
            if (collectedNotes.length === 0) {
                notesList.textContent = 'üéµ –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–æ—Ç';
                notesList.style.color = '#999';
            } else {
                notesList.textContent = collectedNotes.map(n => `${n.note}${n.octave}`).join(' ');
                notesList.style.color = '#495057';
            }
            
            notesCount.textContent = `–í—Å–µ–≥–æ –Ω–æ—Ç: ${collectedNotes.length}`;
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        function parseNotes(input) {
            const rawNotes = input.replace(/,/g, ' ').split(/\s+/).filter(n => n.trim() !== '');
            const parsedNotes = [];
            
            for (const note of rawNotes) {
                const match = note.match(/^([A-Ga-g][#b]?)(\d+)?$/);
                
                if (!match) {
                    return null;
                }
                
                let noteName = match[1].toUpperCase();
                
                // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –Ω–æ—Ç
                const noteMap = {
                    'DB': 'Db', 'EB': 'Eb', 'AB': 'Ab', 'GB': 'Gb', 'BB': 'Bb'
                };
                
                if (noteMap[noteName]) {
                    noteName = noteMap[noteName];
                }
                
                if (!ALL_NOTES.includes(noteName)) {
                    return null;
                }
                
                const octave = match[2] ? parseInt(match[2]) : null;
                parsedNotes.push({ note: noteName, octave: octave });
            }
            
            return parsedNotes;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ—Ç –∏–∑ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        function addManualNotes() {
            const input = document.getElementById('manualInput').value.trim();
            
            if (!input) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ—Ç—ã!');
                return;
            }
            
            const parsedNotes = parseNotes(input);
            
            if (!parsedNotes) {
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –Ω–æ—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: C4 Eb5 F#3 –∏–ª–∏ C Eb F#');
                return;
            }
            
            if (parsedNotes.length > 30) {
                alert(`‚ùå –í—ã –≤–≤–µ–ª–∏ ${parsedNotes.length} –Ω–æ—Ç. –ú–∞–∫—Å–∏–º—É–º 30 –Ω–æ—Ç.`);
                return;
            }
            
            if (collectedNotes.length + parsedNotes.length > 30) {
                alert(`‚ùå –° —É—á—ë—Ç–æ–º —É–∂–µ –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –Ω–æ—Ç –±—É–¥–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≤ 30.\n–°–µ–π—á–∞—Å: ${collectedNotes.length}`);
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ—Ç—ã
            parsedNotes.forEach(n => {
                collectedNotes.push({
                    note: n.note,
                    octave: n.octave !== null ? n.octave : selectedOctave
                });
            });
            
            document.getElementById('manualInput').value = '';
            updateNotesDisplay();
            renderNotation();
        }

        // –¢—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ—Ç
        function transposeNotes() {
            if (collectedNotes.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ—Ç—ã!');
                return;
            }
            
            const semitones = parseInt(document.getElementById('transposeInput').value);
            
            if (isNaN(semitones) || semitones < -12 || semitones > 12) {
                alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç -12 –¥–æ 12');
                return;
            }
            
            const transposed = collectedNotes.map(item => {
                const semitone = NOTE_TO_SEMITONE[item.note];
                let newSemitone = (semitone + semitones) % 12;
                if (newSemitone < 0) newSemitone += 12;
                
                const newNote = SEMITONE_TO_NOTE[newSemitone];
                
                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ–∫—Ç–∞–≤—ã
                let octaveShift = Math.floor((semitone + semitones) / 12);
                if ((semitone + semitones) < 0 && (semitone + semitones) % 12 !== 0) {
                    octaveShift = -1;
                }
                
                const newOctave = item.octave + octaveShift;
                
                return {
                    note: newNote,
                    octave: newOctave
                };
            });
            
            collectedNotes = transposed;
            updateNotesDisplay();
            renderNotation();
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –Ω–æ—Ç—ã
        function clearNotes() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –Ω–æ—Ç—ã?')) {
                collectedNotes = [];
                updateNotesDisplay();
                renderNotation();
            }
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç VexFlow
        function noteToVexFlow(note, octave) {
            const baseNote = VEXFLOW_NOTE_MAP[note] || note[0].toLowerCase();
            
            // –í VexFlow –æ–∫—Ç–∞–≤—ã: 4 = –ø–µ—Ä–≤–∞—è –æ–∫—Ç–∞–≤–∞, 5 = –≤—Ç–æ—Ä–∞—è –∏ —Ç.–¥.
            // –ù–∞–º –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å: 
            // octave 2 (–º–∞–ª–∞—è) -> 3 –≤ VexFlow
            // octave 3 (–ø–µ—Ä–≤–∞—è) -> 4 –≤ VexFlow
            // octave 4 (–≤—Ç–æ—Ä–∞—è) -> 5 –≤ VexFlow
            const vexOctave = octave + 1;
            
            return `${baseNote}/${vexOctave}`;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–æ—Ç–Ω–æ–≥–æ —Å—Ç–∞–Ω–∞
        function renderNotation() {
            if (!vfContext || collectedNotes.length === 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å—Ç–∞–Ω
                const div = document.getElementById('notation');
                div.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">üéµ –î–æ–±–∞–≤—å—Ç–µ –Ω–æ—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
                return;
            }

            try {
                document.getElementById('loading').classList.add('show');
                document.getElementById('errorMessage').classList.remove('show');
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –Ω–æ—Ç–∞—Ü–∏—é
                const div = document.getElementById('notation');
                div.innerHTML = '';
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä–µ—Ä
                vfRenderer = new Vex.Flow.Renderer(div, Vex.Flow.Renderer.Backends.SVG);
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–æ—Ç
                const width = Math.max(400, collectedNotes.length * 80);
                vfRenderer.resize(width, 200);
                
                vfContext = vfRenderer.getContext();
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ—Ç–Ω—ã–π —Å—Ç–∞–Ω
                const stave = new Vex.Flow.Stave(10, 0, width - 20);
                stave.addClef('treble').setContext(vfContext).draw();
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ—Ç—ã
                const notes = collectedNotes.map(item => {
                    const vexNote = noteToVexFlow(item.note, item.octave);
                    return new Vex.Flow.StaveNote({
                        keys: [vexNote],
                        duration: 'q'  // —á–µ—Ç–≤–µ—Ä—Ç–Ω—ã–µ –Ω–æ—Ç—ã
                    });
                });
                
                // –°–æ–∑–¥–∞–µ–º –≥–æ–ª–æ—Å
                const voice = new Vex.Flow.Voice({ num_beats: notes.length, note_value: 4 });
                voice.addTickables(notes);
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                const formatter = new Vex.Flow.Formatter();
                formatter.joinVoices([voice]).format([voice], width - 50);
                
                voice.draw(vfContext, stave);
                
                document.getElementById('loading').classList.remove('show');
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏:', e);
                document.getElementById('loading').classList.remove('show');
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –Ω–æ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞.');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∫ PNG
        function saveAsPNG() {
            const notation = document.getElementById('notation');
            
            if (!notation || collectedNotes.length === 0) {
                alert('–ù–µ—Ç –Ω–æ—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!');
                return;
            }
            
            document.getElementById('loading').classList.add('show');
            
            html2canvas(notation, {
                scale: 2,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const link = document.createElement('a');
                link.download = `notes_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                document.getElementById('loading').classList.remove('show');
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                document.getElementById('loading').classList.remove('show');
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 3000);
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
